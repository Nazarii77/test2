bPauseAttributeRefresh = True
if not (IsOldCompleted) then
SetEventAttributeNumeric("CURRENT EVENT NO",LookupCurrentEventNum)
end if
'CHECK PO----------------------------------------------------------------------
sEventNum = LookupCurrentEventNum
sSendToWs = ReturnFromSQL("SELECT ATTRIBUTE_AS_CHAR FROM EVENTATTRIBUTES WHERE EVENT_NUM = "& sEventNum &" AND COMPANY = '"& LookupEquipmentCompany &"' AND GAGE_SN = '"& LookupEquipmentID &"' AND ATTRIBUTE_NAME = 'SEND TO WS'")
sCompany = LookupEquipmentCompany

    if sSendToWs = "0" then
        'ShowMessage(LookupCurrentEventNum)
        sShipTo = ReturnFromSQL("SELECT ATTRIBUTE_AS_TEXT FROM EVENTATTRIBUTES WHERE EVENT_NUM = "& sEventNum &" AND COMPANY = '"& LookupEquipmentCompany &"' AND GAGE_SN = '"& LookupEquipmentID &"' AND ATTRIBUTE_NAME = 'SHIP TO'")
        'ShowMessage(sShipTo)                                                               
        SetEquipmentFieldText("CUSTOMTEXT6", sShipTo)
    end if

'This script changes equipment status (done by Lily 24/10) -----------------------------------------
    sGuid = ReturnFromSQL("SELECT WO_CUSTOM9 FROM WORK_ORDER WHERE JOB_NUMBER ='" & LookupEquipmentFieldText("CURRENT_WO_NUMBER")& "'")
    'sTransitVendor = ReturnFromSQL("select TRANSIT_VENDOR from GAGES WITH (NOLOCK)  where GAGE_SN = '"& LookupEquipmentID &"'")
    'sSuccessStatus = "APA"   'awaiting parts
    'sActualService = LookupEquipmentFieldText("TRANSIT_CUSTOM_FIELD3")
'ShowMessage(ReplaceSpecialFields("!WORKSTATION_DEPARTMENT!"))
bIsWS =  (InStr( ReplaceSpecialFields("!WORKSTATION_DEPARTMENT!")," WS") > 0)
bIsFS =  (InStr( ReplaceSpecialFields("!WORKSTATION_DEPARTMENT!"), " FS") > 0)
bIsTMC = (InStr( ReplaceSpecialFields("!WORKSTATION_DEPARTMENT!"), " WO") > 0)
bIfPartsEvent = ((ReturnFromSQL("SELECT COUNT (*) FROM REPAIRPARTSEVENTS WHERE EVENT_NUM = "& LookupCurrentEventNum &" AND LINE_TYPE = 0")) > 0)
bGenerateRecParts = False
sCurrentEquip = LookupEquipmentID
sFirstEquip = ReturnFromSQL("SELECT TOP 1 GAGE_SN FROM REPAIRPARTSEVENTS WHERE EVENT_NUM =" & sEventNum)
sFirstEquipStatus = ReturnFromSQL("SELECT EVENT_STATUS FROM GAGES WHERE GAGE_SN ='" & sFirstEquip & "' AND COMPANY = '" & LookupEquipmentCompany & "'")
rIsEmPo = ReturnFromSQL("SELECT ATTRIBUTE_AS_CHAR FROM WORK_ORDER_ATTRIBUTES WHERE JOB_NUMBER = '"& LookupEquipmentFieldText("CURRENT_WO_NUMBER") &"' AND ATTRIBUTE_NAME = 'EMERGENCY PO'")
bIfSuccessSAP = True
'ShowMessage ("  sCurrentEquip  " &sCurrentEquip&"  sFirstEquip  "&  sFirstEquip  &"   rIsEmPo   "&rIsEmPo)
'ShowMessage(((sCurrentEquip = sFirstEquip) and ((rIsEmPo = "0") or (rIsEmPo = ""))))
'ShowMessage("sCurrentEquip " & sCurrentEquip & " sFirstEquip " & sFirstEquip & " rIsEmPo " & rIsEmPo)
if ((sCurrentEquip = sFirstEquip) and ((rIsEmPo = "0") or (rIsEmPo = ""))) then
    'ShowMessage(LookupEventFieldText("CUSTOM_FIELD1"))

    if LookupEventFieldText("CUSTOM_FIELD1") <> "YES" then
        sPO = LookupEventAttributeText("PO NUMBER")
        sAnswer = MsgBox("Message to SAP wasn't sent.
            Press 'Yes' to send message.
            Press 'No' to proceed without sending message.
            Press 'Cancel' to stay on event and send manually.", 35)
        SELECT CASE sAnswer
            CASE "6"
                if (sPO = "") or (sPO = "WAITING PO") or (len(sPO)>35) then
                    AbortAction("PO Number invalid. Required, max length 35 char")
                    bIfSuccessSAP = False
                else
                    if (sGuid<> "") then
                       SetEventAttributeText("METHOD","Z3")
                       sMethod = "Z3_UnplannedWorkToOrder"
                    else
                       SetEventAttributeText("METHOD","Z2")
                       sMethod = "Z2_OrderCreate"
                    end if
                    SetProjectResult(sMethod)
                    if LookupEventFieldText("CUSTOM_FIELD3") <> "" then
                        LaunchScriptProject("CHECK INVENTORY")
                    else            
                        RunSQL("DELETE FROM [REPAIRPARTSEVENTS_EXT] WHERE EVENT_NUM = " & sEventNum)
                    end if
                    LaunchScriptProject("ZXML TEST MULTY")
                    sGuid = ReturnFromSQL("SELECT WO_CUSTOM9 FROM WORK_ORDER WHERE JOB_NUMBER ='" & LookupEquipmentFieldText("CURRENT_WO_NUMBER")& "'")
                    if sGuid <> "" then
                        bIfSuccessSAP = True
                    else
                        AbortAction("GUID number wasn't received.")
                        bIfSuccessSAP = False
                    end if
                 end if
             CASE "7"
                if (sPO = "") or (sPO = "WAITING PO") or (len(sPO)>35) then
                    AbortAction("PO Number invalid. Required, max length 35 char")
                    bIfSuccessSAP = False
                end if
                bIfSuccessSAP = True
             CASE ELSE
                AbortAction("")
                bIfSuccessSAP = False
        END SELECT
    elseif (sGuid <> "") then
        bIfSuccessSAP = True
    end if
elseif (sGuid <> "") then
    bIfSuccessSAP = True
end if
sStatus = ""
if (bIfSuccessSAP = True) then
        if bIsWS then
            if (LookupEventAttributeBoolean("SEND TO VENDOR") = "1") then
                sStatus = "AVR"   
            elseif (bIfPartsEvent) then
                sStatus = "APA"
            else
            sStatus = "ARP" 'Awaiting Repair
            bGenerateRecParts = True
            end if
        elseif bIsFS then
            if (bIfPartsEvent) then
                sStatus = "APA"
            else
                sStatus = "ATA" 'Await Tech Ass.
                bGenerateRecParts = True
            end if
        elseif bIsTMC then
            if (bIfPartsEvent) then
                sStatus = "APA"
            else
            sStatus = "ARO" 'Awaiting Rep OnSite
            bGenerateRecParts = True
            end if
        end if

    SetEquipmentFieldText("EVENT_STATUS", sStatus)
end if
if (bGenerateRecParts) then
'Event Generation--------------------------
                        sNewInt = LookupNewEventNum
                        sRandom = Random
                        RunSQL("INSERT INTO EVENTS (EVENT_NUM, OUTEQUIP_NUM, COMPANY, GAGE_SN, EVENT_TYPE, EVENT_DATE, EVENT_TIME, USER_FNAME, " &
                            "DONE_BY_FNAME, PO_NUMBER, CUSTOM_FIELD1, CUSTOM_FIELD2, MACHINE, EVENT_STATUS, EVENT_COMMENT, VENDOR) VALUES " &
                            "(" & sNewInt & ", " & sNewInt & ", '" & LookupEquipmentCompany & "', '" & LookupEquipmentID & "', 'URECEIVE PARTS', '" &
                            FormatDateTimeForSQL(Date) & "', '" & FormatDateTimeForSQL(Time) & "', '" & LookupCurrentUser & "', '" &
                            LookupCurrentUserEmployeeInfo("EMP_ID") & "',  '" & LookupEquipmentFieldText("LAB_CUSTOM3") & "', '" & sRandom & "', '" & LookupEquipmentFieldText("LAB_CUSTOM2") &
                            "',  '" & LookupEquipmentFieldText("LAB_CUSTOM4") & "', " &
                            "'COMPLETE', 'No parts required - this was was auto-created upon completion of ORDER', '" & LookupEquipmentFieldText("CURRENT_VENDOR") & "')")
                         RunSQL("INSERT INTO EVENTEQUIP (OUTEQUIP_NUM, COMPANY, EQUIP_NUMBER, CRIB_NUMBER, BIN_NUMBER, IS_GAGE) VALUES " &
                            "(" & sNewInt & ", '" & LookupEquipmentCompany & "', '" & LookupEquipmentID & "', 'N/A', 'N/A', '1')")
'---------------------------------------------------------------------------------
end if


'/CHECK PO----------------------------------------------------------------------




LaunchScriptProject("YORDER FINISH")
LaunchScriptProject("YSET SHIPPING CONDITION")
'UPDATE COSTCENTER--------------------------------------------------------------
LaunchScriptProject("YUPDATE COSTCENTER")
sCribOnEvent = LookupEventAttributeText("CRIB")
RunSQL("UPDATE WORK_ORDER SET WO_CUSTOM1 = '"&sCribOnEvent&"' WHERE JOB_NUMBER = '" & LookupEquipmentFieldText("CURRENT_WO_NUMBER") & "'")
'/UPDATE COSTCENTER--------------------------------------------------------------
'UPDATE HOMEVIEW-----------------------------------------------------------------
SetProjectResult("SET")
LaunchScriptProject("EQUIPMENT NOTES CONTROL")
SetEquipmentFieldDate("CURRENT_RETURN_DATE",LookupEventFieldNumeric("RETURN_DATE"))
SetEquipmentFieldNumeric("GAGE_COST", LookupEventFieldNumeric("COST"))
'/UPDATE HOMEVIEW-----------------------------------------------------------------
sPO = LookupEventAttributeText("PO NUMBER")
if ((sPO <> "") and (sPO <> "WAITING PO") and (len(sPO)<35)) then
    if (LookupEventAttributeBoolean("DECREMENTED PO") = 0) then
        LaunchScriptProject("DECREMENT PO")
    end if
end if
LaunchScriptProject("RUN RULES")
SetEventAttributeText("CURR_EVNUM",sEventNum)   
bPauseAttributeRefresh = False
RefreshEventTable("EVENTATTRIBUTES")
RefreshHomeViewOnClose
